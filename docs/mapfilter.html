<!DOCTYPE html>

<html>
<head>
  <title>MapFilter.js 0.1.0</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="mapfilter-js-0-1-0">MapFilter.js 0.1.0</h1>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <pre><code>(c) 2013-2014 Gregor MacLennan, Digital Democracy
MapFilter may be freely distributed under the MIT license.
</code></pre><h2 id="initial-setup">Initial Setup</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>MapFilter = Backbone.View.extend({
    initialize: <span class="function"><span class="keyword">function</span><span class="params">(options)</span> {</span>
        window.app = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>For this initial load of data do not trigger add events, but instead
trigger a custom event to refresh views and filters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.collection.fetch({
            silent: <span class="literal">true</span>, 
            success: <span class="function"><span class="keyword">function</span><span class="params">(collection, resp, options)</span> {</span>
                collection.trigger(<span class="string">"firstfetch"</span>, collection, resp, options);
            }
        });

        <span class="keyword">this</span>.mapPane = <span class="keyword">new</span> MapFilter.MapPane({ 
            el: $(<span class="string">'&lt;div id="map"/&gt;'</span>).appendTo(<span class="keyword">this</span>.el),
            center: options.mapCenter,
            zoom: options.mapZoom,
            tileUrl: options.tileUrl,
            collection: <span class="keyword">this</span>.collection
        });

        <span class="keyword">this</span>.filterPane = <span class="keyword">new</span> MapFilter.FilterPane({
            collection: <span class="keyword">this</span>.collection,
            filters: options.filters
        });

        <span class="keyword">this</span>.currentViewInfo = <span class="keyword">new</span> MapFilter.CurrentViewInfo();

        <span class="keyword">this</span>.infoPane = <span class="keyword">new</span> MapFilter.InfoPane();

        <span class="keyword">this</span>.$el.append(<span class="keyword">this</span>.filterPane.render().el);
        <span class="keyword">this</span>.$el.append(<span class="keyword">this</span>.infoPane.$el.hide());
        <span class="keyword">this</span>.mapPane.$(<span class="string">".leaflet-control-container"</span>).prepend(<span class="keyword">this</span>.currentViewInfo.render().el);
    }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="mapfilter-collection">MapFilter.Collection</h2>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>This collection of models (data records) extends<br><a href="http://square.github.io/crossfilter/">crossfilter()</a> 
to allow fast filtering by different filters / dimensions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>MapFilter.Collection = Backbone.Collection.extend({

    initialize: <span class="function"><span class="keyword">function</span><span class="params">(models, options)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Pass the url endpoint for this collection in the options hash</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (options.url) <span class="keyword">this</span>.url = options.url;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Initialize a new <a href="http://square.github.io/crossfilter/">crossfilter</a> instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.crossfilter = crossfilter();</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Stores a reference to each dimension created on the crossfilter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.dimensions = [];
        <span class="keyword">this</span>.resetFilter();
        <span class="keyword">this</span>.on(<span class="string">"change remove reset"</span>, <span class="keyword">this</span>.resetFilter);
        <span class="keyword">this</span>.on(<span class="string">"add firstfetch"</span>, <span class="keyword">this</span>.addToFilter);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>A wrapper for <code>crossfilter().dimension</code> which stores a reference
to the dimension which allows for the crossfilter to be reset later </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dimension: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
        <span class="keyword">var</span> dimension = <span class="keyword">this</span>.crossfilter.dimension(value);
        <span class="keyword">this</span>.dimensions.push(dimension);
        <span class="keyword">return</span> dimension;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Clears the filters on all the dimensions and removes all records
and re-adds them (<code>crossfilter().remove</code> only removes unfiltered records) </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    resetFilter: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">this</span>.dimensions.forEach(<span class="function"><span class="keyword">function</span><span class="params">(dimension)</span> {</span>
            dimension.filterAll();
        });
        <span class="keyword">this</span>.crossfilter.remove();
        <span class="keyword">this</span>.addToFilter(<span class="keyword">this</span>.models);
        <span class="keyword">return</span> <span class="keyword">this</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Adds either a single model or a collection of models to the crossfilter </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    addToFilter: <span class="function"><span class="keyword">function</span><span class="params">(records)</span> {</span>
        <span class="keyword">if</span> (records <span class="keyword">instanceof</span> Backbone.Collection)
            records = records.models;
        <span class="keyword">return</span> <span class="keyword">this</span>.crossfilter.add(records);
    }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h2 id="mapfilter-mappane">MapFilter.MapPane</h2>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>The MapFilter MapPane manages the map and markers on the map, hiding markers which
do not match the current filter whenever the filter changes.</p>
<p><code>options.center</code> is a [lat,lon] array of the starting center point for the map
<code>options.zoom</code> is the initial zoom level for the map                                                                                                                                   this.markersById[model.cid]       =    new           MapFilter.MarkerView({ model: model, map:             this.map });     } [description]
<code>options.tileUrl</code> is <a href="http://leafletjs.com/reference.html#url-template">URL template</a> for map tile layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>MapFilter.MapPane = Backbone.View.extend({

    initialize: <span class="function"><span class="keyword">function</span><span class="params">(options)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Initialize the <a href="http://leafletjs.com/">Leaflet</a> map attaching to this view&#39;s element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.map = L.map(<span class="keyword">this</span>.el, {
            center: options.center,
            zoom: options.zoom,
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Add the background tile layer to the map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.tiles = L.tileLayer(options.tileUrl).addTo(<span class="keyword">this</span>.map);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Object to hold a reference to any markers added to the map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.markersById = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Crossfilter dimension based on model cid (Backbone&#39;s internal id
assigned to new models)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.dimension = <span class="keyword">this</span>.collection.dimension(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.cid;
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>This will group models by cid, which is unique, which means that
each group will have a count of 0 or 1 depending on whether
the model matches the filters set on the other crossfilter dimensions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.group = <span class="keyword">this</span>.dimension.group();</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>When a new model is created, add a new marker to the map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.listenTo(<span class="keyword">this</span>.collection, <span class="string">'add'</span>, <span class="keyword">this</span>.addOne);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>When the models are initially fetched, or the collection is reset
remove and re-add all the markers to the map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.listenTo(<span class="keyword">this</span>.collection, <span class="string">'firstfetch reset'</span>, <span class="keyword">this</span>.addAll);</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Remove a marker from the map when the model is removed from collection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.listenTo(<span class="keyword">this</span>.collection, <span class="string">'remove'</span>, <span class="keyword">this</span>.removeOne);</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Filter which markers are hidden or shown whenever the collection
is filtered</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.listenTo(<span class="keyword">this</span>.collection, <span class="string">'filtered'</span>, <span class="keyword">this</span>.filter);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Create a new MarkerView for each model added to the collection,
and store a reference to that view in markersById </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    addOne: <span class="function"><span class="keyword">function</span><span class="params">(model)</span> {</span>
        <span class="keyword">this</span>.markersById[model.cid] = <span class="keyword">new</span> MapFilter.MarkerView({
            model: model,
            map: <span class="keyword">this</span>.map
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Remove all the markers from the map and add a marker for each model
in the collection </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    addAll: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">this</span>.removeAll();
        <span class="keyword">this</span>.collection.each(<span class="keyword">this</span>.addOne, <span class="keyword">this</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Remove a single marker for a given model from the map </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    removeOne: <span class="function"><span class="keyword">function</span><span class="params">(model)</span> {</span>
        <span class="keyword">this</span>.markersById[model.cid].remove();</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Remove reference to marker to allow garbage collection;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">delete</span> <span class="keyword">this</span>.markersById[model.cid];
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Remove all markers from the map </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    removeAll: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        _.each(<span class="keyword">this</span>.markersById, <span class="function"><span class="keyword">function</span><span class="params">(v)</span> {</span>
            <span class="keyword">this</span>.removeOne(v.model);
        }, <span class="keyword">this</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p><code>this.group.all()</code> is an array of every model in the collection by <code>cid</code>. 
The value will be 0 for filtered models, 1 for models that are unfiltered.
This loops through <code>this.group.all()</code> and calls <code>MapFilter.MarkerView.show()</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    filter: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">this</span>.group.all().forEach(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">this</span>.markersById[d.key].show(d.value);
        }, <span class="keyword">this</span>);
    }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h2 id="mapfilter-markerview">MapFilter.MarkerView</h2>

            </div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>MapFilter MarkerView manages the markers displayed on the map. It should be 
initialized with a reference to the model and to the map in the options hash</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>MapFilter.MarkerView = Backbone.View.extend({

    events: {
        <span class="string">"mouseover"</span>: <span class="string">"onMouseOver"</span>,
        <span class="string">"mouseout"</span>: <span class="string">"onMouseOut"</span>,
        <span class="string">"click"</span>: <span class="string">"onClick"</span>
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>The default icon is an svg icon wrapped in a div</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    icon: L.divIcon({
        html: <span class="string">'&lt;svg&gt;&lt;g transform="translate(4,4.5)"&gt;'</span> + 
              <span class="string">'&lt;path class="outline" d="M 17,8 C 17,13 11,21 8.5,23.5 C 6,21 0,13 0,8 C 0,4 4,-0.5 8.5,-0.5 C 13,-0.5 17,4 17,8 z"/&gt;'</span> + 
              <span class="string">'&lt;path class="fill" d="M 17,8 C 17,13 11,21 8.5,23.5 C 6,21 0,13 0,8 C 0,4 4,-0.5 8.5,-0.5 C 13,-0.5 17,4 17,8 z"/&gt;'</span> + 
              <span class="string">'&lt;/g&gt;&lt;/svg&gt;'</span> + 
              <span class="string">'&lt;div class="marker-text"/&gt;'</span>,
        iconSize: [<span class="number">25</span>, <span class="number">34</span>],
        iconAnchor: [<span class="number">25</span> / <span class="number">2</span>, <span class="number">30</span>],
        className: <span class="string">"marker"</span>
    }),

    initialize: <span class="function"><span class="keyword">function</span><span class="params">(options)</span> {</span>
        <span class="keyword">var</span> loc = <span class="keyword">this</span>.model.coordinates();</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Sometimes models (monitoring reports) do not have coordinates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (!loc[<span class="number">0</span>] || !loc[<span class="number">1</span>]) loc = [<span class="number">0</span>, <span class="number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Create a new marker with the default icon and add to the map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.marker = L.marker(loc, {
            icon: <span class="keyword">this</span>.icon
        }).addTo(options.map);</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Store a reference the icon div from this view&#39;s <code>el</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.setElement(<span class="keyword">this</span>.marker._icon);</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Add className from the model&#39;s &quot;happening&quot; field
<strong>TODO</strong> remove this dependency and color markers from array of colors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.$el.addClass(<span class="keyword">this</span>.model.get(<span class="string">"happening"</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Reference the marker&#39;s current z-index (we change the z-index later
when the markers are filtered, so unfiltered markers appear on top)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>._lastZIndex = <span class="keyword">this</span>.marker.options.zIndexOffset;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>TODO: remove/update this </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    render: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        $(<span class="string">".marker-text"</span>, <span class="keyword">this</span>.el).html(<span class="string">""</span>);
        <span class="keyword">this</span>.marker.update();
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Removes this marker from the map </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    remove: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">this</span>.marker._map.removeLayer(<span class="keyword">this</span>.marker);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>When the mouse is over the marker, show the info pane </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    onMouseOver: <span class="function"><span class="keyword">function</span><span class="params">(e)</span> {</span>
        e.stopPropagation();
        <span class="keyword">this</span>.$el.addClass(<span class="string">"hover"</span>);
        app.infoPane.show({
            model: <span class="keyword">this</span>.model
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Hide the infopane when the mouse leaves the marker </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    onMouseOut: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">this</span>.$el.removeClass(<span class="string">"hover"</span>);
        app.infoPane.hide();
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>When you click the marker, make the infoPane &quot;stick&quot; open
until you click on another marker </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    onClick: <span class="function"><span class="keyword">function</span><span class="params">(e)</span> {</span>
        e.stopPropagation();
        <span class="keyword">this</span>.$el.toggleClass(<span class="string">"clicked"</span>);
        app.infoPane.toggle({
            model: <span class="keyword">this</span>.model,
            sticky: <span class="literal">true</span>,
            iconView: <span class="keyword">this</span>
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Shows or &#39;hides&#39; a marker (hiding actually just reduces opacity
and send the marker behind shown markers)
<code>shown</code> is a boolean for whether the marker should be shown</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    show: <span class="function"><span class="keyword">function</span><span class="params">(shown)</span> {</span>
        <span class="keyword">this</span>.marker.setOpacity(shown ? <span class="number">1</span> : <span class="number">0.15</span>);
        <span class="keyword">if</span> (shown) {
            <span class="keyword">this</span>.marker.setZIndexOffset(<span class="keyword">this</span>._lastZIndex);
        } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Move &#39;hidden&#39; markers behind the others</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>._lastZIndex = <span class="keyword">this</span>.marker.options.zIndexOffset;
            <span class="keyword">this</span>.marker.setZIndexOffset(-<span class="number">99999</span>);
        }
    }
});
<span class="comment">/**
 * Shows a readable description of the current filters in place
 * TODO: Finish this
 */</span>
MapFilter.CurrentViewInfo = Backbone.View.extend({

    id: <span class="string">"filter-info"</span>,

    render: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">this</span>.$el.html(<span class="string">"Showing &lt;strong&gt;all activities&lt;/strong&gt; by &lt;strong&gt;all monitors&lt;/strong&gt; on &lt;strong&gt;all dates&lt;/strong&gt;"</span>);
        <span class="keyword">return</span> <span class="keyword">this</span>;
    },

    constructFilterText: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>

    }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h2 id="mapfilter-infopane">MapFilter.InfoPane</h2>

            </div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>The InfoPane manages the display of the attributes and media associated
with a point. It appears on mouseover/hover of a point, but if you click
the point then it will &quot;stick&quot; open.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>MapFilter.InfoPane = Backbone.View.extend({

    id: <span class="string">"info-pane"</span>,

    events: {
        <span class="string">"click .close"</span>: <span class="string">"close"</span>
    },

    initialize: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">this</span>.template = _.template($(<span class="string">"#template-info-pane"</span>).html());
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Populates the infopane contents with the data from the selected point</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    render: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">this</span>.$el.html(<span class="keyword">this</span>.template(<span class="keyword">this</span>.model));
    },

    show: <span class="function"><span class="keyword">function</span><span class="params">(options)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">this</span>.sticky()) <span class="keyword">return</span>;
        <span class="keyword">this</span>.hide();
        <span class="keyword">this</span>.model = options.model;
        <span class="keyword">this</span>.iconView = options.iconView;
        <span class="keyword">this</span>.render();
        <span class="keyword">this</span>.sticky(options.sticky);
        <span class="keyword">this</span>.$el.show();
    },

    toggle: <span class="function"><span class="keyword">function</span><span class="params">(options)</span> {</span>
        <span class="keyword">this</span>.sticky(<span class="literal">false</span>);
        <span class="keyword">if</span> (<span class="keyword">this</span>.iconView === options.iconView) {
            <span class="keyword">this</span>.hide();
            <span class="keyword">this</span>.iconView = <span class="literal">null</span>;
        } <span class="keyword">else</span> {
            <span class="keyword">if</span> (<span class="keyword">this</span>.iconView) <span class="keyword">this</span>.iconView.$el.removeClass(<span class="string">"clicked"</span>);
            <span class="keyword">this</span>.show(options);
        }
    },

    sticky: <span class="function"><span class="keyword">function</span><span class="params">(sticky)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> sticky === <span class="string">"undefined"</span>) <span class="keyword">return</span> <span class="keyword">this</span>._sticky;
        <span class="keyword">if</span> (sticky) {
            <span class="keyword">this</span>.$el.addClass(<span class="string">"sticky"</span>);
        } <span class="keyword">else</span> {
            <span class="keyword">this</span>.$el.removeClass(<span class="string">"sticky"</span>);
        }
        <span class="keyword">this</span>._sticky = sticky;
    },

    close: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">this</span>.sticky(<span class="literal">false</span>);
        <span class="keyword">if</span> (<span class="keyword">this</span>.iconView) <span class="keyword">this</span>.iconView.$el.removeClass(<span class="string">"hover clicked"</span>);
        <span class="keyword">this</span>.hide();
    },

    hide: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">this</span>.sticky()) <span class="keyword">return</span>;
        <span class="keyword">this</span>.$el.hide();
    }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <h2 id="mapfilter-filterpane">MapFilter.FilterPane</h2>

            </div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>The FilterPane shows the list of filters that can be used to explore data.
It creates a filter view for each filter in the array <code>options.filters</code>
which should have the following properties:</p>
<ul>
<li><code>field</code> is the field/attribute to filter by</li>
<li><code>type</code> should be <code>discrete</code> for string data and <code>continuous</code> for numbers or dates</li>
<li><code>expanded</code> sets whether the filter view is expanded or collapsed by default    </li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>MapFilter.FilterPane = Backbone.View.extend({

    id: <span class="string">"filter-pane"</span>,

    initialize: <span class="function"><span class="keyword">function</span><span class="params">(options)</span> {</span>
        <span class="keyword">var</span> filters = options.filters || [];</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Initialize a graph pane to hold charts for continuous filters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.graphPane = <span class="keyword">new</span> MapFilter.GraphPane({
            collection: <span class="keyword">this</span>.collection
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Append the graph parent to this pane&#39;s parent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.$el.append(<span class="keyword">this</span>.graphPane.render().el);

        <span class="keyword">this</span>.$filters = $(<span class="string">'&lt;form class="form"/&gt;'</span>).appendTo(<span class="keyword">this</span>.el);</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Loop through each filter and add a view to the pane</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        filters.forEach(<span class="function"><span class="keyword">function</span><span class="params">(filter)</span> {</span>
            <span class="keyword">this</span>.addFilter(filter);
        }, <span class="keyword">this</span>);

    },</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Add a filter on a field to the filter pane.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    addFilter: <span class="function"><span class="keyword">function</span><span class="params">(options)</span> {</span>
        <span class="keyword">var</span> filterView;

        <span class="keyword">if</span> (!options.field) {
            console.error(t(<span class="string">"error.filter_missing"</span>));
            <span class="keyword">return</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Initialize a ContinuousFilterView or DiscreteFilterView
ContinousFilterView is linked to the GraphPane which will show
the bar chart for selecting ranges of data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (options.type === <span class="string">"continuous"</span>) {
            filterView = <span class="keyword">new</span> MapFilter.ContinuousFilterView({
                collection: <span class="keyword">this</span>.collection,
                field: options.field,
                expanded: options.expanded || <span class="literal">false</span>,
                graphPane: <span class="keyword">this</span>.graphPane
            });
        } <span class="keyword">else</span> {
            filterView = <span class="keyword">new</span> MapFilter.DiscreteFilterView({
                collection: <span class="keyword">this</span>.collection,
                field: options.field,
                expanded: options.expanded || <span class="literal">false</span>
            });
        }

        <span class="keyword">this</span>.$filters.append(filterView.render().el);
    }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <h2 id="mapfilter-discretefilterview">MapFilter.DiscreteFilterView</h2>

            </div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Creates a view to filter the collection by a discrete field
(i.e. a string value or list of space-separated tags).
Pass <code>options.field</code> with the name of the field/attribute to filter on.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>MapFilter.DiscreteFilterView = Backbone.View.extend({

    events: {
        <span class="string">"click .select_all"</span>: <span class="string">"selectAll"</span>,
        <span class="string">"click .select_one"</span>: <span class="string">"selectOne"</span>,
        <span class="string">"click"</span>: <span class="string">"updateFilter"</span>
    },

    className: <span class="string">"filter"</span>,

    initialize: <span class="function"><span class="keyword">function</span><span class="params">(options)</span> {</span>
        <span class="keyword">var</span> field = <span class="keyword">this</span>.field = options.field;
        <span class="keyword">this</span>.$el.attr(<span class="string">"id"</span>, field);</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>The template a partial are coded into the html</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.template = _.template($(<span class="string">"#template-discrete-filter"</span>).html());
        <span class="keyword">this</span>.checkboxTemplate = _.template($(<span class="string">"#template-checkbox"</span>).html());</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p><code>v</code> is the row in the dataset
<code>p</code> is <code>{}</code> for the first execution (passed from reduceInitial). 
For every subsequent execution it is the value returned from reduceAdd of the prev row</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="function"><span class="keyword">function</span> <span class="title">reduceAdd</span><span class="params">(p, v)</span> {</span>
            v.get(field).split(<span class="string">" "</span>).forEach(<span class="function"><span class="keyword">function</span><span class="params">(val, idx)</span> {</span>
                p[val] = (p[val] || <span class="number">0</span>) + <span class="number">1</span>; <span class="comment">//increment counts</span>
            });
            <span class="keyword">return</span> p;
        }

        <span class="function"><span class="keyword">function</span> <span class="title">reduceRemove</span><span class="params">(p, v)</span> {</span>
            v.get(field).split(<span class="string">" "</span>).forEach(<span class="function"><span class="keyword">function</span><span class="params">(val, idx)</span> {</span>
                p[val] -= <span class="number">1</span>;
            });
            <span class="keyword">return</span> p;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>this is how our reduce function is seeded. similar to how inject or fold 
works in functional languages. this map will contain the final counts 
by the time we are done reducing our entire data set.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="function"><span class="keyword">function</span> <span class="title">reduceInitial</span><span class="params">()</span> {</span>
            <span class="keyword">return</span> {};  
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Create a dimension on the field for filtering</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.dimension = <span class="keyword">this</span>.collection.dimension(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span> <span class="keyword">return</span> d.get(field); });</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>This reduces the collection down to an object with a key for each
unique value of the filter field, with the value as the count
of the number of models with that field.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.groupAll = <span class="keyword">this</span>.dimension.groupAll().reduce(reduceAdd, reduceRemove, reduceInitial);</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>When the collection first loads or models change, re-render the filter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.listenTo(<span class="keyword">this</span>.collection, <span class="string">'firstfetch change'</span>, <span class="keyword">this</span>.render);

        <span class="keyword">this</span>.render();
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Renders the template with a list of checkboxes for each value to filter on </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    render: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>If there is no data, noop</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (!<span class="keyword">this</span>.dimension.group().size()) <span class="keyword">return</span> <span class="keyword">this</span>;

        <span class="keyword">var</span> checkboxes = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Create an array of checkboxes for each unique value of the filter field</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _.forEach(<span class="keyword">this</span>.groupAll.value(), <span class="function"><span class="keyword">function</span><span class="params">(v, k)</span> {</span>
            checkboxes.push(<span class="keyword">this</span>.checkboxTemplate({
                key: k, 
                text: t(<span class="keyword">this</span>.field + <span class="string">"."</span> + k), 
                labelClass: (<span class="keyword">this</span>.field === <span class="string">"happening"</span>) ? <span class="string">"label"</span> : <span class="string">""</span>,
                className: <span class="string">"checkbox "</span> + k
            }));
        }, <span class="keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Render the filter&#39;s template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.$el.html(<span class="keyword">this</span>.template({
            title: t(<span class="string">"filters."</span> + <span class="keyword">this</span>.field),
            checkboxes: checkboxes
        }));

        <span class="keyword">return</span> <span class="keyword">this</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Select all items in this filter </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    selectAll: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">this</span>.$(<span class="string">"input"</span>).prop(<span class="string">"checked"</span>, <span class="literal">true</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Select a single value for this filter and unselect others</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    selectOne: <span class="function"><span class="keyword">function</span><span class="params">(e)</span> {</span>
        <span class="keyword">this</span>.$(<span class="string">"input"</span>).prop(<span class="string">"checked"</span>, <span class="literal">false</span>);
        $(e.target).parents(<span class="string">".checkbox"</span>).find(<span class="string">"input"</span>).prop(<span class="string">"checked"</span>, <span class="literal">true</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Update the filter on the collection whenever the selection changes </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    updateFilter: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> selected = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Create an array of selected values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.$(<span class="string">"input:checked"</span>).each(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            selected.push($(<span class="keyword">this</span>).attr(<span class="string">"value"</span>));
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Set a filter to match values including lists of
space-separated tags</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.dimension.filter(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> _.intersection(d.split(<span class="string">" "</span>), selected).length ? <span class="literal">true</span> : <span class="literal">false</span>;
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Trigger an event on the collection so that other views can
update with the new filtered collection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.collection.trigger(<span class="string">"filtered"</span>);
    }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <h2 id="mapfilter-continuousfilterview">MapFilter.ContinuousFilterView</h2>

            </div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>The ContinuousFilterView is used for filtering via date or integer fields
It shows the currently selected range and the GraphPane which displays
a barchart that allows a filter range to be selected.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>MapFilter.ContinuousFilterView = Backbone.View.extend({

    events: {
        <span class="string">"click .select_range"</span>: <span class="string">"showGraphPane"</span>
    },

    className: <span class="string">'filter'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Pass the <code>options.field</code> to filter by, and a reference to the GraphPane
with <code>options.graphPane</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    initialize: <span class="function"><span class="keyword">function</span><span class="params">(options)</span> {</span>
        <span class="keyword">this</span>.field = options.field;
        <span class="keyword">this</span>.graphPane = options.graphPane;
        <span class="keyword">this</span>.$el.attr(<span class="string">"id"</span>, <span class="keyword">this</span>.field);

        <span class="keyword">this</span>.template = _.template($(<span class="string">"#template-continuous-filter"</span>).html());
        <span class="keyword">this</span>.dimension = <span class="keyword">this</span>.collection.dimension(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span> <span class="keyword">return</span> <span class="keyword">new</span> Date(d.attributes[<span class="keyword">this</span>.field]); });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Simply renders the template and sets the view element html.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    render: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">this</span>.$el.html(<span class="keyword">this</span>.template());
        <span class="keyword">return</span> <span class="keyword">this</span>;
    },

    showGraphPane: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">this</span>.graphPane.toggle();
    }
});
MapFilter.GraphPane = Backbone.View.extend({

    id: <span class="string">"graph-pane"</span>,

    events: {
        <span class="string">"click .close"</span>: <span class="string">"hide"</span>
    },

    initialize: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">this</span>.$el.append(<span class="string">'&lt;button type="button" class="close" aria-hidden="true"&gt;&amp;times;&lt;/button&gt;'</span>);
        <span class="keyword">var</span> date = <span class="keyword">this</span>.collection.dimension(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span> <span class="keyword">return</span> <span class="keyword">new</span> Date(d.attributes.today); }),
            dates = date.group(d3.time.day);

        <span class="keyword">this</span>.barChart = MapFilter.BarChart()
            .dimension(date)
            .group(dates)
            .round(d3.time.day.round)
          .x(d3.time.scale()
            .domain([<span class="keyword">new</span> Date(<span class="number">2013</span>, <span class="number">9</span>, <span class="number">1</span>), <span class="keyword">new</span> Date(<span class="number">2013</span>, <span class="number">11</span>, <span class="number">20</span>)])
            .rangeRound([<span class="number">0</span>, <span class="number">1400</span>]))
            .on(<span class="string">"brush"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
                self.collection.trigger(<span class="string">"filtered"</span>);
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>d3.select(this.el).call(barChart);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    },

    render: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>

        <span class="keyword">return</span> <span class="keyword">this</span>;
    },

    hide: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        app.$el.removeClass(<span class="string">"show-date-filter"</span>);
    },

    toggle: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        app.$el.toggleClass(<span class="string">"show-date-filter"</span>);
        d3.select(<span class="keyword">this</span>.el).call(<span class="keyword">this</span>.barChart);
    },

    show: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        app.$el.addClass(<span class="string">"show-date-filter"</span>);
    }
});
MapFilter.BarChart = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
    <span class="keyword">if</span> (!MapFilter.BarChart.id) MapFilter.BarChart.id = <span class="number">0</span>;

    <span class="keyword">var</span> margin = {top: <span class="number">10</span>, right: <span class="number">10</span>, bottom: <span class="number">20</span>, left: <span class="number">10</span>},
        x,
        y = d3.scale.linear().range([<span class="number">100</span>, <span class="number">0</span>]),
        id = MapFilter.BarChart.id++,
        axis = d3.svg.axis().orient(<span class="string">"bottom"</span>),
        brush = d3.svg.brush(),
        brushDirty,
        dimension,
        group,
        round;

    <span class="function"><span class="keyword">function</span> <span class="title">chart</span><span class="params">(div)</span> {</span>
      <span class="keyword">var</span> width = x.range()[<span class="number">1</span>],
          height = y.range()[<span class="number">0</span>];

      y.domain([<span class="number">0</span>, group.top(<span class="number">1</span>)[<span class="number">0</span>].value]);

      div.each(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> div = d3.select(<span class="keyword">this</span>),
            g = div.select(<span class="string">"g"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Create the skeletal chart.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (g.empty()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>div.select(&quot;.title&quot;).append(&quot;a&quot;)
    .attr(&quot;href&quot;, &quot;javascript:reset(&quot; + id + &quot;)&quot;)
    .attr(&quot;class&quot;, &quot;reset&quot;)
    .text(&quot;reset&quot;)
    .style(&quot;display&quot;, &quot;none&quot;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          g = div.append(<span class="string">"svg"</span>)
              .attr(<span class="string">"width"</span>, width + margin.left + margin.right)
              .attr(<span class="string">"height"</span>, height + margin.top + margin.bottom)
            .append(<span class="string">"g"</span>)
              .attr(<span class="string">"transform"</span>, <span class="string">"translate("</span> + margin.left + <span class="string">","</span> + margin.top + <span class="string">")"</span>);

          g.append(<span class="string">"clipPath"</span>)
              .attr(<span class="string">"id"</span>, <span class="string">"clip-"</span> + id)
            .append(<span class="string">"rect"</span>)
              .attr(<span class="string">"width"</span>, width)
              .attr(<span class="string">"height"</span>, height);

          g.selectAll(<span class="string">".bar"</span>)
              .data([<span class="string">"background"</span>, <span class="string">"foreground"</span>])
            .enter().append(<span class="string">"path"</span>)
              .attr(<span class="string">"class"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span> <span class="keyword">return</span> d + <span class="string">" bar"</span>; })
              .datum(group.all());

          g.selectAll(<span class="string">".foreground.bar"</span>)
              .attr(<span class="string">"clip-path"</span>, <span class="string">"url(#clip-"</span> + id + <span class="string">")"</span>);

          g.append(<span class="string">"g"</span>)
              .attr(<span class="string">"class"</span>, <span class="string">"axis"</span>)
              .attr(<span class="string">"transform"</span>, <span class="string">"translate(0,"</span> + height + <span class="string">")"</span>)
              .call(axis);</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Initialize the brush component with pretty resize handles.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">var</span> gBrush = g.append(<span class="string">"g"</span>).attr(<span class="string">"class"</span>, <span class="string">"brush"</span>).call(brush);
          gBrush.selectAll(<span class="string">"rect"</span>).attr(<span class="string">"height"</span>, height);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Only redraw the brush if set externally.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (brushDirty) {
          brushDirty = <span class="literal">false</span>;
          g.selectAll(<span class="string">".brush"</span>).call(brush);</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>div.select(&quot;.title a&quot;).style(&quot;display&quot;, brush.empty() ? &quot;none&quot; : null);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span> (brush.empty()) {
            g.selectAll(<span class="string">"#clip-"</span> + id + <span class="string">" rect"</span>)
                .attr(<span class="string">"x"</span>, <span class="number">0</span>)
                .attr(<span class="string">"width"</span>, width);
          } <span class="keyword">else</span> {
            <span class="keyword">var</span> extent = brush.extent();
            g.selectAll(<span class="string">"#clip-"</span> + id + <span class="string">" rect"</span>)
                .attr(<span class="string">"x"</span>, x(extent[<span class="number">0</span>]))
                .attr(<span class="string">"width"</span>, x(extent[<span class="number">1</span>]) - x(extent[<span class="number">0</span>]));
          }
        }

        g.selectAll(<span class="string">".bar"</span>).attr(<span class="string">"d"</span>, barPath);
      });

      <span class="function"><span class="keyword">function</span> <span class="title">barPath</span><span class="params">(groups)</span> {</span>
        <span class="keyword">var</span> path = [],
            i = -<span class="number">1</span>,
            n = groups.length,
            d;
        <span class="keyword">while</span> (++i &lt; n) {
          d = groups[i];
          path.push(<span class="string">"M"</span>, x(d.key), <span class="string">","</span>, height, <span class="string">"V"</span>, y(d.value), <span class="string">"h14V"</span>, height);
        }
        <span class="keyword">return</span> path.join(<span class="string">""</span>);
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>brush.on(&quot;brushstart.chart&quot;, function() {
  var div = d3.select(this.parentNode.parentNode.parentNode);
  div.select(&quot;.title a&quot;).style(&quot;display&quot;, null);
});</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    brush.on(<span class="string">"brush.chart"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
      <span class="keyword">var</span> g = d3.select(<span class="keyword">this</span>.parentNode),
          extent = brush.extent();
      <span class="keyword">if</span> (round) g.select(<span class="string">".brush"</span>)
          .call(brush.extent(extent = extent.map(round)))
        .selectAll(<span class="string">".resize"</span>)
          .style(<span class="string">"display"</span>, <span class="literal">null</span>);
      g.select(<span class="string">"#clip-"</span> + id + <span class="string">" rect"</span>)
          .attr(<span class="string">"x"</span>, x(extent[<span class="number">0</span>]))
          .attr(<span class="string">"width"</span>, x(extent[<span class="number">1</span>]) - x(extent[<span class="number">0</span>]));
      dimension.filterRange(extent);
    });

    brush.on(<span class="string">"brushend.chart"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
      <span class="keyword">if</span> (brush.empty()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>var div = d3.select(this.parentNode.parentNode.parentNode);
div.select(&quot;.title a&quot;).style(&quot;display&quot;, &quot;none&quot;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        d3.select(<span class="string">"#clip-"</span> + id + <span class="string">" rect"</span>).attr(<span class="string">"x"</span>, <span class="literal">null</span>).attr(<span class="string">"width"</span>, <span class="string">"100%"</span>);
        dimension.filterAll();
      }
    });

    chart.margin = <span class="function"><span class="keyword">function</span><span class="params">(_)</span> {</span>
      <span class="keyword">if</span> (!arguments.length) <span class="keyword">return</span> margin;
      margin = _;
      <span class="keyword">return</span> chart;
    };

    chart.x = <span class="function"><span class="keyword">function</span><span class="params">(_)</span> {</span>
      <span class="keyword">if</span> (!arguments.length) <span class="keyword">return</span> x;
      x = _;
      axis.scale(x);
      brush.x(x);
      <span class="keyword">return</span> chart;
    };

    chart.y = <span class="function"><span class="keyword">function</span><span class="params">(_)</span> {</span>
      <span class="keyword">if</span> (!arguments.length) <span class="keyword">return</span> y;
      y = _;
      <span class="keyword">return</span> chart;
    };

    chart.dimension = <span class="function"><span class="keyword">function</span><span class="params">(_)</span> {</span>
      <span class="keyword">if</span> (!arguments.length) <span class="keyword">return</span> dimension;
      dimension = _;
      <span class="keyword">return</span> chart;
    };

    chart.filter = <span class="function"><span class="keyword">function</span><span class="params">(_)</span> {</span>
      <span class="keyword">if</span> (_) {
        brush.extent(_);
        dimension.filterRange(_);
      } <span class="keyword">else</span> {
        brush.clear();
        dimension.filterAll();
      }
      brushDirty = <span class="literal">true</span>;
      <span class="keyword">return</span> chart;
    };

    chart.group = <span class="function"><span class="keyword">function</span><span class="params">(_)</span> {</span>
      <span class="keyword">if</span> (!arguments.length) <span class="keyword">return</span> group;
      group = _;
      <span class="keyword">return</span> chart;
    };

    chart.round = <span class="function"><span class="keyword">function</span><span class="params">(_)</span> {</span>
      <span class="keyword">if</span> (!arguments.length) <span class="keyword">return</span> round;
      round = _;
      <span class="keyword">return</span> chart;
    };

    <span class="keyword">return</span> d3.rebind(chart, brush, <span class="string">"on"</span>);
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
